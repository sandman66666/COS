<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | AI Chief of Staff</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
        }
        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        .header {
            background-color: #4a6fdc;
            color: white;
            padding: 1.5rem;
            border-radius: 10px 10px 0 0;
            margin: -2rem -2rem 2rem -2rem;
        }
        .service-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.2s ease;
        }
        .service-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .service-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        .connected {
            color: #198754;
        }
        .disconnected {
            color: #dc3545;
        }
        .sync-status {
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        .progress {
            height: 10px;
            margin-top: 0.5rem;
        }
        h1 {
            font-weight: 600;
        }
        .nav-link {
            color: #4a6fdc;
        }
        .nav-link:hover {
            color: #3a5bb9;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">AI Chief of Staff</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/chat">Chat</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/email-insights">Email Insights</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/settings">Settings</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mb-5">
        <div class="settings-container">
            <div class="header">
                <h1>Settings</h1>
                <p class="mb-0">Manage your integrations and preferences</p>
            </div>
            
            <h2 class="mb-4">Connected Services</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="service-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <i class="bi bi-envelope service-icon {{ 'connected' if is_gmail_connected else 'disconnected' }}"></i>
                                <h3>Gmail</h3>
                                <p>Connect your Gmail account to enable email intelligence features.</p>
                                <div class="card-body">
                                    <h5 class="card-title">Gmail Connection</h5>
                                    {% if gmail_connected %}
                                    <div class="badge bg-success mb-3">Connected</div>
                                    
                                    <div class="sync-status">
                                        {% if last_sync %}
                                            <div class="mb-2">
                                                <small class="text-muted">Last synced: {{ last_sync }}</small>
                                            </div>
                                        {% endif %}
                                        
                                        {% if sync_status and sync_status.is_syncing %}
                                            <div class="d-flex justify-content-between mb-2">
                                                <span class="text-primary">Syncing in progress...</span>
                                            </div>
                                            <div class="progress mb-3">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                    role="progressbar" 
                                                    aria-valuenow="{{ sync_status.progress if sync_status else 0 }}" 
                                                    aria-valuemin="0" 
                                                    aria-valuemax="100" 
                                                    style="width: {{ sync_status.progress if sync_status else 0 }}%;"></div>
                                            </div>
                                        {% endif %}
                                        
                                        <div class="mt-3">
                                            <form action="/sync-emails" method="post" style="display:inline;">
                                                <button type="submit" class="btn btn-outline-primary btn-sm">Sync Now</button>
                                            </form>
                                            <button id="forceRefreshBtn" class="btn btn-outline-success btn-sm ms-2">
                                                <i class="bi bi-arrow-repeat"></i> Force Refresh Data
                                            </button>
                                            <a href="/disconnect-gmail" class="btn btn-outline-danger btn-sm ms-2">Disconnect</a>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="badge bg-secondary mb-3">Not Connected</div>
                                    <a href="/login" class="btn btn-primary">Connect Gmail</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="service-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <i class="bi bi-calendar3 service-icon disconnected"></i>
                                <h3>Google Calendar</h3>
                                <p>Connect your Google Calendar for scheduling and event management.</p>
                                <div class="badge bg-secondary mb-3">Coming Soon</div>
                                <button class="btn btn-outline-secondary" disabled>Connect Calendar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="service-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <i class="bi bi-kanban service-icon disconnected"></i>
                                <h3>ClickUp</h3>
                                <p>Connect ClickUp for task and project management integration.</p>
                                <div class="badge bg-secondary mb-3">Coming Soon</div>
                                <button class="btn btn-outline-secondary" disabled>Connect ClickUp</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="service-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <i class="bi bi-slack service-icon disconnected"></i>
                                <h3>Slack</h3>
                                <p>Connect Slack for communication and notification integration.</p>
                                <div class="badge bg-secondary mb-3">Coming Soon</div>
                                <button class="btn btn-outline-secondary" disabled>Connect Slack</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <h2 class="mb-4 mt-5">Knowledge Structure</h2>
            
            <!-- Projects & Initiatives Section -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0">Projects & Initiatives</h3>
                    <p class="text-muted small mb-0">Define your main projects to help organize insights</p>
                </div>
                <div class="card-body">
                    <div id="projectsList">
                        {% if projects %}
                            {% for project in projects %}
                                <div class="project-item mb-3 border-bottom pb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h5>{{ project.name }}</h5>
                                            <p class="mb-1">{{ project.description }}</p>
                                            <div class="mb-2">
                                                <span class="badge bg-{{ project.status_color }}">{{ project.status }}</span>
                                                {% if project.priority %}
                                                <span class="badge bg-{{ project.priority_color }} ms-1">{{ project.priority }}</span>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">Key stakeholders: {{ project.stakeholders|join(', ') }}</small>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary edit-project" data-project-id="{{ project.id }}">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger delete-project" data-project-id="{{ project.id }}">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No projects defined yet. Add your first project below.</p>
                        {% endif %}
                    </div>
                    
                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addProjectModal">
                        <i class="bi bi-plus-circle"></i> Add New Project
                    </button>
                </div>
            </div>
            
            <!-- Goals Section -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0">Goals & Objectives</h3>
                    <p class="text-muted small mb-0">Define your personal and professional goals</p>
                </div>
                <div class="card-body">
                    <div id="goalsList">
                        {% if goals %}
                            {% for goal in goals %}
                                <div class="goal-item mb-3 border-bottom pb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h5>{{ goal.title }}</h5>
                                            <p class="mb-1">{{ goal.description }}</p>
                                            <div class="mb-2">
                                                <span class="badge bg-{{ goal.category_color }}">{{ goal.category }}</span>
                                                <span class="badge bg-{{ goal.timeframe_color }} ms-1">{{ goal.timeframe }}</span>
                                            </div>
                                            {% if goal.metrics %}
                                            <small class="text-muted">Success metrics: {{ goal.metrics }}</small>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary edit-goal" data-goal-id="{{ goal.id }}">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger delete-goal" data-goal-id="{{ goal.id }}">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No goals defined yet. Add your first goal below.</p>
                        {% endif %}
                    </div>
                    
                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addGoalModal">
                        <i class="bi bi-plus-circle"></i> Add New Goal
                    </button>
                </div>
            </div>
            
            <!-- Knowledge Base Files Section -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0">Knowledge Base Files</h3>
                    <p class="text-muted small mb-0">Upload documents to enhance your knowledge base</p>
                </div>
                <div class="card-body">
                    <div id="filesList">
                        {% if knowledge_files %}
                            {% for file in knowledge_files %}
                                <div class="file-item mb-3 border-bottom pb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h5>{{ file.filename }}</h5>
                                            <p class="mb-1">{{ file.description }}</p>
                                            <div class="mb-2">
                                                <span class="badge bg-secondary">{{ file.file_type }}</span>
                                                <span class="badge bg-info ms-1">{{ file.category }}</span>
                                                <small class="text-muted ms-2">Uploaded: {{ file.uploaded_at }}</small>
                                            </div>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary view-file" data-file-id="{{ file.id }}">View</button>
                                            <button class="btn btn-sm btn-outline-danger delete-file" data-file-id="{{ file.id }}">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No knowledge files uploaded yet.</p>
                        {% endif %}
                    </div>
                    
                    <form id="uploadFileForm" enctype="multipart/form-data" class="mt-3">
                        <div class="mb-3">
                            <label for="fileUpload" class="form-label">Upload File</label>
                            <input class="form-control" type="file" id="fileUpload" name="file">
                        </div>
                        <div class="mb-3">
                            <label for="fileDescription" class="form-label">File Description</label>
                            <textarea class="form-control" id="fileDescription" name="description" rows="2" placeholder="What does this file contain?"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="fileCategory" class="form-label">Category</label>
                            <select class="form-select" id="fileCategory" name="category">
                                <option value="company_overview">Company Overview</option>
                                <option value="product_specs">Product Specifications</option>
                                <option value="marketing">Marketing Materials</option>
                                <option value="strategy">Strategic Documents</option>
                                <option value="research">Research</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-upload"></i> Upload File
                        </button>
                    </form>
                </div>
            </div>
            
            <h2 class="mb-4 mt-5">Preferences</h2>
            
            <div class="mb-3">
                <label for="syncFrequency" class="form-label">Email Sync Frequency</label>
                <select class="form-select" id="syncFrequency">
                    <option value="1" {{ 'selected' if email_sync_frequency == 1 else '' }}>Every hour</option>
                    <option value="3" {{ 'selected' if email_sync_frequency == 3 else '' }}>Every 3 hours</option>
                    <option value="6" {{ 'selected' if email_sync_frequency == 6 else '' }}>Every 6 hours</option>
                    <option value="12" {{ 'selected' if email_sync_frequency == 12 else '' }}>Every 12 hours</option>
                    <option value="24" {{ 'selected' if email_sync_frequency == 24 else '' }}>Once a day</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="emailDaysBack" class="form-label">Email Analysis Lookback Period</label>
                <select class="form-select" id="emailDaysBack">
                    <option value="7" {{ 'selected' if email_days_back == 7 else '' }}>7 days</option>
                    <option value="14" {{ 'selected' if email_days_back == 14 else '' }}>14 days</option>
                    <option value="30" {{ 'selected' if email_days_back == 30 else '' }}>30 days</option>
                    <option value="60" {{ 'selected' if email_days_back == 60 else '' }}>60 days</option>
                    <option value="90" {{ 'selected' if email_days_back == 90 else '' }}>90 days</option>
                </select>
            </div>
            
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="urgentAlerts" {{ 'checked' if urgent_alerts_enabled else '' }}>
                <label class="form-check-label" for="urgentAlerts">
                    Enable urgent email alerts
                </label>
            </div>
            
            <button id="savePreferences" class="btn btn-primary">Save Preferences</button>
        </div>
        
        <!-- Database Management Section -->
        <div class="card mt-5 mb-4">
            <div class="card-header bg-light">
                <h3 class="mb-0">Database Management</h3>
                <p class="text-muted small mb-0">Reset your application data</p>
            </div>
            <div class="card-body">
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle-fill"></i> Warning</h5>
                    <p>Resetting the database will permanently delete all your data including:</p>
                    <ul>
                        <li>All projects and goals</li>
                        <li>All knowledge files</li>
                        <li>All email insights and analysis</li>
                        <li>All tasks and notes</li>
                        <li>All people and relationship data</li>
                    </ul>
                    <p class="mb-0">This action cannot be undone.</p>
                </div>
                
                <button id="resetDbBtn" class="btn btn-danger">
                    <i class="bi bi-trash"></i> Reset Database
                </button>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProjectModalLabel">Add New Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="projectForm">
                        <input type="hidden" id="projectId" value="">
                        <div class="mb-3">
                            <label for="projectName" class="form-label">Project Name</label>
                            <input type="text" class="form-control" id="projectName" required>
                        </div>
                        <div class="mb-3">
                            <label for="projectDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="projectDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="projectStatus" class="form-label">Status</label>
                                <select class="form-select" id="projectStatus">
                                    <option value="active">Active</option>
                                    <option value="planning">Planning</option>
                                    <option value="on_hold">On Hold</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="projectPriority" class="form-label">Priority</label>
                                <select class="form-select" id="projectPriority">
                                    <option value="">-- Select Priority --</option>
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="projectStakeholders" class="form-label">Key Stakeholders</label>
                            <input type="text" class="form-control" id="projectStakeholders" placeholder="Comma-separated list of names">
                        </div>
                        <div class="mb-3">
                            <label for="projectKeywords" class="form-label">Keywords</label>
                            <input type="text" class="form-control" id="projectKeywords" placeholder="Comma-separated list of keywords for matching emails">
                            <div class="form-text">These keywords will be used to associate emails with this project.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProject">Save Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Goal Modal -->
    <div class="modal fade" id="addGoalModal" tabindex="-1" aria-labelledby="addGoalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addGoalModalLabel">Add New Goal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="goalForm">
                        <input type="hidden" id="goalId" value="">
                        <div class="mb-3">
                            <label for="goalTitle" class="form-label">Goal Title</label>
                            <input type="text" class="form-control" id="goalTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="goalDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="goalDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="goalCategory" class="form-label">Category</label>
                                <select class="form-select" id="goalCategory">
                                    <option value="professional">Professional</option>
                                    <option value="personal">Personal</option>
                                    <option value="learning">Learning & Development</option>
                                    <option value="financial">Financial</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="goalTimeframe" class="form-label">Timeframe</label>
                                <select class="form-select" id="goalTimeframe">
                                    <option value="short_term">Short Term (< 3 months)</option>
                                    <option value="medium_term">Medium Term (3-12 months)</option>
                                    <option value="long_term">Long Term (> 1 year)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="goalMetrics" class="form-label">Success Metrics</label>
                            <textarea class="form-control" id="goalMetrics" rows="2" placeholder="How will you measure success?"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="goalKeywords" class="form-label">Keywords</label>
                            <input type="text" class="form-control" id="goalKeywords" placeholder="Comma-separated list of keywords for matching emails">
                            <div class="form-text">These keywords will be used to associate emails with this goal.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveGoal">Save Goal</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Add event listener for force refresh button
        document.getElementById('forceRefreshBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to force refresh all data from Gmail? This may take a while.')) {
                this.disabled = true;
                this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Refreshing...';
                
                fetch('/api/force-refresh', {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Start polling for status
                        checkSyncStatus();
                    } else {
                        alert('Error starting refresh: ' + data.error);
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Force Refresh Data';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while starting the refresh');
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Force Refresh Data';
                });
            }
        });
        
        // Function to check sync status
        function checkSyncStatus() {
            fetch('/api/sync-status')
                .then(response => response.json())
                .then(data => {
                    const refreshBtn = document.getElementById('forceRefreshBtn');
                    
                    if (data.is_syncing) {
                        refreshBtn.disabled = true;
                        refreshBtn.innerHTML = `<i class="bi bi-arrow-repeat"></i> Refreshing (${data.progress}%)`;
                        
                        // Update progress bar if it exists
                        const progressBar = document.querySelector('.progress-bar');
                        if (progressBar) {
                            progressBar.style.width = `${data.progress}%`;
                            progressBar.setAttribute('aria-valuenow', data.progress);
                        }
                        
                        // Check again in 2 seconds
                        setTimeout(checkSyncStatus, 2000);
                    } else {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Force Refresh Data';
                        
                        // Reload the page to show updated data
                        if (data.progress === 100) {
                            window.location.reload();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking sync status:', error);
                    document.getElementById('forceRefreshBtn').disabled = false;
                    document.getElementById('forceRefreshBtn').innerHTML = '<i class="bi bi-arrow-repeat"></i> Force Refresh Data';
                });
        }
        
        document.getElementById('savePreferences').addEventListener('click', function() {
            // Get form values
            const syncFrequency = document.getElementById('syncFrequency').value;
            const emailDaysBack = document.getElementById('emailDaysBack').value;
            const urgentAlertsEnabled = document.getElementById('urgentAlerts').checked;
            
            // Send to backend
            fetch('/api/save-preferences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email_sync_frequency: syncFrequency,
                    email_days_back: emailDaysBack,
                    urgent_alerts_enabled: urgentAlertsEnabled
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Preferences saved successfully!');
                } else {
                    alert('Error saving preferences: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving preferences.');
            });
        });
        
        // Database reset button
        document.getElementById('resetDbBtn').addEventListener('click', function() {
            if (confirm('WARNING: This will permanently delete ALL your data. This action CANNOT be undone. Are you absolutely sure?')) {
                if (confirm('FINAL WARNING: All your projects, goals, tasks, and insights will be permanently deleted. Type "RESET" to confirm.')) {
                    const userInput = prompt('Type "RESET" to confirm database reset:');
                    if (userInput === 'RESET') {
                        // Show loading spinner
                        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Resetting...';
                        this.disabled = true;
                        
                        fetch('/api/reset-database', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Database has been reset successfully. The application will now reload.');
                                window.location.href = '/';
                            } else {
                                alert('Error resetting database: ' + data.error);
                                this.innerHTML = '<i class="bi bi-trash"></i> Reset Database';
                                this.disabled = false;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while resetting the database.');
                            this.innerHTML = '<i class="bi bi-trash"></i> Reset Database';
                            this.disabled = false;
                        });
                    }
                }
            }
        });
        
        // Check sync status periodically if syncing is in progress
        /* Jinja2 template conditional start */
        /* {% if is_email_syncing %} */
        var isEmailSyncing = {{ is_email_syncing|tojson }};
        if (isEmailSyncing) {
            (function() {
                function checkSyncStatus() {
                    fetch('/api/sync-status')
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.is_syncing) {
                            document.querySelector('.progress-bar').style.width = data.progress + '%';
                            setTimeout(checkSyncStatus, 2000);
                        } else {
                            window.location.reload();
                        }
                    });
                }
                
                // Start checking sync status
                setTimeout(checkSyncStatus, 2000);
            })();
        }
        /* {% endif %} */
        /* Jinja2 template conditional end */
        
        // Project form handling
        document.getElementById('saveProject').addEventListener('click', function() {
            const projectId = document.getElementById('projectId').value;
            const projectData = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                status: document.getElementById('projectStatus').value,
                priority: document.getElementById('projectPriority').value,
                stakeholders: document.getElementById('projectStakeholders').value.split(',').map(s => s.trim()).filter(s => s),
                keywords: document.getElementById('projectKeywords').value.split(',').map(s => s.trim()).filter(s => s)
            };
            
            const url = projectId ? `/api/projects/${projectId}` : '/api/projects';
            const method = projectId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(projectData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addProjectModal'));
                    modal.hide();
                    window.location.reload();
                } else {
                    alert('Error saving project: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the project.');
            });
        });
        
        // Edit project button handlers
        document.querySelectorAll('.edit-project').forEach(button => {
            button.addEventListener('click', function() {
                const projectId = this.getAttribute('data-project-id');
                
                fetch(`/api/projects/${projectId}`)
                .then(response => response.json())
                .then(project => {
                    document.getElementById('projectId').value = project.id;
                    document.getElementById('projectName').value = project.name;
                    document.getElementById('projectDescription').value = project.description || '';
                    document.getElementById('projectStatus').value = project.status || 'active';
                    document.getElementById('projectPriority').value = project.priority || '';
                    document.getElementById('projectStakeholders').value = (project.stakeholders || []).join(', ');
                    document.getElementById('projectKeywords').value = (project.keywords || []).join(', ');
                    
                    document.getElementById('addProjectModalLabel').textContent = 'Edit Project';
                    const modal = new bootstrap.Modal(document.getElementById('addProjectModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while loading the project data.');
                });
            });
        });
        
        // Delete project button handlers
        document.querySelectorAll('.delete-project').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this project?')) {
                    const projectId = this.getAttribute('data-project-id');
                    
                    fetch(`/api/projects/${projectId}`, {
                        method: 'DELETE',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Error deleting project: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the project.');
                    });
                }
            });
        });
        
        // Goal form handling
        document.getElementById('saveGoal').addEventListener('click', function() {
            const goalId = document.getElementById('goalId').value;
            const goalData = {
                title: document.getElementById('goalTitle').value,
                description: document.getElementById('goalDescription').value,
                category: document.getElementById('goalCategory').value,
                timeframe: document.getElementById('goalTimeframe').value,
                metrics: document.getElementById('goalMetrics').value,
                keywords: document.getElementById('goalKeywords').value.split(',').map(s => s.trim()).filter(s => s)
            };
            
            const url = goalId ? `/api/goals/${goalId}` : '/api/goals';
            const method = goalId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(goalData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addGoalModal'));
                    modal.hide();
                    window.location.reload();
                } else {
                    alert('Error saving goal: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the goal.');
            });
        });
        
        // Edit goal button handlers
        document.querySelectorAll('.edit-goal').forEach(button => {
            button.addEventListener('click', function() {
                const goalId = this.getAttribute('data-goal-id');
                
                fetch(`/api/goals/${goalId}`)
                .then(response => response.json())
                .then(goal => {
                    document.getElementById('goalId').value = goal.id;
                    document.getElementById('goalTitle').value = goal.title;
                    document.getElementById('goalDescription').value = goal.description || '';
                    document.getElementById('goalCategory').value = goal.category || 'professional';
                    document.getElementById('goalTimeframe').value = goal.timeframe || 'medium_term';
                    document.getElementById('goalMetrics').value = goal.metrics || '';
                    document.getElementById('goalKeywords').value = (goal.keywords || []).join(', ');
                    
                    document.getElementById('addGoalModalLabel').textContent = 'Edit Goal';
                    const modal = new bootstrap.Modal(document.getElementById('addGoalModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while loading the goal data.');
                });
            });
        });
        
        // Delete goal button handlers
        document.querySelectorAll('.delete-goal').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this goal?')) {
                    const goalId = this.getAttribute('data-goal-id');
                    
                    fetch(`/api/goals/${goalId}`, {
                        method: 'DELETE',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Error deleting goal: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the goal.');
                    });
                }
            });
        });
        
        // File upload form handling
        document.getElementById('uploadFileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/api/knowledge-files', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('File uploaded successfully!');
                    window.location.reload();
                } else {
                    alert('Error uploading file: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while uploading the file.');
            });
        });
        
        // View file button handlers
        document.querySelectorAll('.view-file').forEach(button => {
            button.addEventListener('click', function() {
                const fileId = this.getAttribute('data-file-id');
                window.open(`/api/knowledge-files/${fileId}/view`, '_blank');
            });
        });
        
        // Delete file button handlers
        document.querySelectorAll('.delete-file').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this file?')) {
                    const fileId = this.getAttribute('data-file-id');
                    
                    fetch(`/api/knowledge-files/${fileId}`, {
                        method: 'DELETE',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Error deleting file: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the file.');
                    });
                }
            });
        });
    </script>
</body>
</html>
