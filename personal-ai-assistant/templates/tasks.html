{% extends "layout.html" %}

{% block title %}Tasks | Chief of Staff AI{% endblock %}

{% block additional_styles %}
<style>
    .task-list {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .task-item {
        background-color: #fff;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-left: 4px solid #4a6fdc;
    }
    .task-item.completed {
        border-left-color: #28a745;
        opacity: 0.7;
    }
    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .task-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin: 0;
    }
    .task-actions {
        display: flex;
        gap: 0.5rem;
    }
    .task-metadata {
        display: flex;
        gap: 1rem;
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    .task-source {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .task-date {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .task-description {
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
    }
    .task-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .task-tag {
        background-color: #e9ecef;
        border-radius: 16px;
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
    }
    .task-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    .task-filter {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    .task-filter.active {
        background-color: #4a6fdc;
        color: white;
        border-color: #4a6fdc;
    }
    .task-filter:hover:not(.active) {
        border-color: #4a6fdc;
        color: #4a6fdc;
    }
    .task-add-form {
        background-color: #fff;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }
    .form-control:focus {
        border-color: #4a6fdc;
        outline: none;
    }
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-container">
    <div class="header">
        <h1>Tasks</h1>
        <p class="mb-0">Manage your tasks extracted from emails and conversations</p>
    </div>
    
    <button class="btn btn-primary mb-3" id="newTaskBtn">
        <i class="bi bi-plus-circle"></i> New Task
    </button>
    
    <div class="task-add-form" id="taskAddForm" style="display: none;">
        <h3>Add New Task</h3>
        <form id="addTaskForm">
            <div class="form-group">
                <label for="taskTitle" class="form-label">Title</label>
                <input type="text" id="taskTitle" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="taskDescription" class="form-label">Description</label>
                <textarea id="taskDescription" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="taskDueDate" class="form-label">Due Date</label>
                <input type="date" id="taskDueDate" class="form-control">
            </div>
            <div class="form-group">
                <label for="taskPriority" class="form-label">Priority</label>
                <select id="taskPriority" class="form-control">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskTags" class="form-label">Tags (comma separated)</label>
                <input type="text" id="taskTags" class="form-control">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelAddTask">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Task</button>
            </div>
        </form>
    </div>
    
    <div class="task-filters">
        <div class="task-filter active" data-filter="all">All Tasks</div>
        <div class="task-filter" data-filter="active">Active</div>
        <div class="task-filter" data-filter="completed">Completed</div>
        <div class="task-filter" data-filter="today">Due Today</div>
        <div class="task-filter" data-filter="overdue">Overdue</div>
        <div class="task-filter" data-filter="email">From Email</div>
        <div class="task-filter" data-filter="chat">From Chat</div>
    </div>
    
    <div class="task-list" id="taskList">
        <!-- Tasks will be loaded here -->
    </div>
    
    <div class="empty-state" id="emptyState" style="display: none;">
        <i class="bi bi-check2-circle"></i>
        <h3>No tasks found</h3>
        <p>You don't have any tasks matching the current filter.</p>
    </div>
</div>

<!-- Task Item Template -->
<template id="taskItemTemplate">
    <div class="task-item" data-id="">
        <div class="task-header">
            <h3 class="task-title"></h3>
            <div class="task-actions">
                <button class="btn btn-sm btn-outline-success complete-task" title="Mark as Complete">
                    <i class="bi bi-check-circle"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary edit-task" title="Edit Task">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-task" title="Delete Task">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        <div class="task-metadata">
            <div class="task-source">
                <i class="bi bi-envelope"></i>
                <span class="source-text"></span>
            </div>
            <div class="task-date">
                <i class="bi bi-calendar"></i>
                <span class="date-text"></span>
            </div>
            <div class="task-priority">
                <i class="bi bi-flag"></i>
                <span class="priority-text"></span>
            </div>
        </div>
        <div class="task-description"></div>
        <div class="task-tags"></div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const taskList = document.getElementById('taskList');
        const emptyState = document.getElementById('emptyState');
        const taskAddForm = document.getElementById('taskAddForm');
        const newTaskBtn = document.getElementById('newTaskBtn');
        const cancelAddTaskBtn = document.getElementById('cancelAddTask');
        const addTaskForm = document.getElementById('addTaskForm');
        const taskFilters = document.querySelectorAll('.task-filter');
        
        let currentFilter = 'all';
        let tasks = [];
        
        // Toggle task form visibility
        newTaskBtn.addEventListener('click', function() {
            taskAddForm.style.display = 'block';
            newTaskBtn.style.display = 'none';
        });
        
        cancelAddTaskBtn.addEventListener('click', function() {
            taskAddForm.style.display = 'none';
            newTaskBtn.style.display = 'block';
            addTaskForm.reset();
        });
        
        // Handle form submission
        addTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newTask = {
                id: Date.now().toString(),
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                dueDate: document.getElementById('taskDueDate').value,
                priority: document.getElementById('taskPriority').value,
                tags: document.getElementById('taskTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                completed: false,
                source: 'manual',
                createdAt: new Date().toISOString()
            };
            
            // Send to server
            fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newTask),
            })
            .then(response => response.json())
            .then(data => {
                tasks.push(data);
                renderTasks();
                taskAddForm.style.display = 'none';
                newTaskBtn.style.display = 'block';
                addTaskForm.reset();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to create task. Please try again.');
            });
        });
        
        // Filter tasks
        taskFilters.forEach(filter => {
            filter.addEventListener('click', function() {
                taskFilters.forEach(f => f.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                renderTasks();
            });
        });
        
        // Fetch tasks from server
        function fetchTasks() {
            fetch('/api/tasks')
                .then(response => response.json())
                .then(data => {
                    tasks = data;
                    renderTasks();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showEmptyState('Failed to load tasks. Please refresh the page.');
                });
        }
        
        // Render tasks based on current filter
        function renderTasks() {
            taskList.innerHTML = '';
            
            const filteredTasks = filterTasks(tasks, currentFilter);
            
            if (filteredTasks.length === 0) {
                showEmptyState();
                return;
            }
            
            emptyState.style.display = 'none';
            
            filteredTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                taskList.appendChild(taskElement);
            });
        }
        
        // Filter tasks based on selected filter
        function filterTasks(tasks, filter) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            return tasks.filter(task => {
                const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                dueDate?.setHours(0, 0, 0, 0);
                
                switch(filter) {
                    case 'all':
                        return true;
                    case 'active':
                        return !task.completed;
                    case 'completed':
                        return task.completed;
                    case 'today':
                        return dueDate && dueDate.getTime() === today.getTime();
                    case 'overdue':
                        return dueDate && dueDate < today && !task.completed;
                    case 'email':
                        return task.source === 'email';
                    case 'chat':
                        return task.source === 'chat';
                    default:
                        return true;
                }
            });
        }
        
        // Create task element from template
        function createTaskElement(task) {
            const template = document.getElementById('taskItemTemplate');
            const taskElement = document.importNode(template.content, true).querySelector('.task-item');
            
            taskElement.dataset.id = task.id;
            if (task.completed) {
                taskElement.classList.add('completed');
            }
            
            taskElement.querySelector('.task-title').textContent = task.title;
            taskElement.querySelector('.task-description').textContent = task.description || 'No description';
            
            // Set source icon and text
            const sourceElement = taskElement.querySelector('.source-text');
            const sourceIcon = taskElement.querySelector('.task-source i');
            if (task.source === 'email') {
                sourceElement.textContent = 'From Email';
                sourceIcon.className = 'bi bi-envelope';
            } else if (task.source === 'chat') {
                sourceElement.textContent = 'From Chat';
                sourceIcon.className = 'bi bi-chat-text';
            } else {
                sourceElement.textContent = 'Manual Entry';
                sourceIcon.className = 'bi bi-person';
            }
            
            // Set due date
            const dateElement = taskElement.querySelector('.date-text');
            if (task.dueDate) {
                const dueDate = new Date(task.dueDate);
                dateElement.textContent = dueDate.toLocaleDateString();
                
                // Check if overdue
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (dueDate < today && !task.completed) {
                    dateElement.style.color = '#dc3545';
                }
            } else {
                dateElement.textContent = 'No due date';
            }
            
            // Set priority
            const priorityElement = taskElement.querySelector('.priority-text');
            priorityElement.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            if (task.priority === 'high') {
                priorityElement.style.color = '#dc3545';
            } else if (task.priority === 'medium') {
                priorityElement.style.color = '#fd7e14';
            }
            
            // Add tags
            const tagsContainer = taskElement.querySelector('.task-tags');
            if (task.tags && task.tags.length > 0) {
                task.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'task-tag';
                    tagElement.textContent = tag;
                    tagsContainer.appendChild(tagElement);
                });
            }
            
            // Add event listeners for actions
            taskElement.querySelector('.complete-task').addEventListener('click', function() {
                toggleTaskCompletion(task.id);
            });
            
            taskElement.querySelector('.edit-task').addEventListener('click', function() {
                editTask(task.id);
            });
            
            taskElement.querySelector('.delete-task').addEventListener('click', function() {
                deleteTask(task.id);
            });
            
            return taskElement;
        }
        
        // Toggle task completion status
        function toggleTaskCompletion(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const updatedTask = {...task, completed: !task.completed};
            
            fetch(`/api/tasks/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedTask),
            })
            .then(response => response.json())
            .then(data => {
                const index = tasks.findIndex(t => t.id === taskId);
                tasks[index] = data;
                renderTasks();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update task. Please try again.');
            });
        }
        
        // Edit task
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Populate form with task data
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskDueDate').value = task.dueDate || '';
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskTags').value = task.tags ? task.tags.join(', ') : '';
            
            // Show form
            taskAddForm.style.display = 'block';
            newTaskBtn.style.display = 'none';
            
            // Update form submission handler
            const originalSubmitHandler = addTaskForm.onsubmit;
            addTaskForm.onsubmit = function(e) {
                e.preventDefault();
                
                const updatedTask = {
                    ...task,
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    dueDate: document.getElementById('taskDueDate').value,
                    priority: document.getElementById('taskPriority').value,
                    tags: document.getElementById('taskTags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
                };
                
                fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedTask),
                })
                .then(response => response.json())
                .then(data => {
                    const index = tasks.findIndex(t => t.id === taskId);
                    tasks[index] = data;
                    renderTasks();
                    taskAddForm.style.display = 'none';
                    newTaskBtn.style.display = 'block';
                    addTaskForm.reset();
                    
                    // Restore original submit handler
                    addTaskForm.onsubmit = originalSubmitHandler;
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update task. Please try again.');
                });
            };
        }
        
        // Delete task
        function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            
            fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (response.ok) {
                    tasks = tasks.filter(t => t.id !== taskId);
                    renderTasks();
                } else {
                    throw new Error('Failed to delete task');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete task. Please try again.');
            });
        }
        
        // Show empty state with custom message
        function showEmptyState(message) {
            const emptyStateMsg = emptyState.querySelector('p');
            if (message) {
                emptyStateMsg.textContent = message;
            } else {
                emptyStateMsg.textContent = 'You don\'t have any tasks matching the current filter.';
            }
            emptyState.style.display = 'block';
            taskList.innerHTML = '';
        }
        
        // Initialize
        fetchTasks();
    });
</script>
{% endblock %}
